@using LogicaNegocio.Extra
@model PublicacionDTO

<div class="pub-card mb-4">
    <!-- Encabezado -->
    <div class="pub-header">
        <img src="@Model.ImagenAutorURL" class="pub-autor-img" alt="autor" />
        <div>
            <p class="pub-autor-nombre">@Model.NombreAutor</p>
            <p class="pub-fecha">@Model.FechaCreacion.ToShortDateString()</p>
        </div>
    </div>

    <!-- Título -->
    <h5 class="pub-titulo">@Model.Titulo</h5>
    <!-- Descripción -->
    <div class="pub-descripcion" data-publicacion-id="@Model.Id">
        <span class="pub-texto-resumen">@Model.Descripcion</span>
        <button class="pub-btn-vermas" data-id="@Model.Id">Ver más</button>
    </div>

    <!-- Slideshow -->
   @if (Model.Medias != null && Model.Medias.Count > 0)
{
    <div class="pub-slideshow" id="slideshow-@Model.Id">
        <div class="pub-slide-container">
            @foreach (var media in Model.Medias)
            {
                <div class="pub-slide">
                    @if (media.Tipo == Enum_TipoMedia.Imagen)
                    {
                        <img src="@media.Url" class="pub-slide-img" />
                    }
                    else
                    {
                        <video src="@media.Url" class="pub-slide-video" controls></video>
                    }
                </div>
            }
        </div>

        @if (Model.Medias.Count > 1)
        {
            <button class="pub-slide-btn left" onclick="cambiarSlide(@Model.Id, -1)">❮</button>
            <button class="pub-slide-btn right" onclick="cambiarSlide(@Model.Id, 1)">❯</button>

            <div class="pub-slide-dots">
                @for (int i = 0; i < Model.Medias.Count; i++)
                {
                    <span class="pub-slide-dot @(i == 0 ? "active" : "")"
                          onclick="cambiarSlide(@Model.Id, @i - slideIndices[@Model.Id] || 0)">
                    </span>
                }
            </div>
        }
    </div>
}


    
    <!-- Interacciones -->
    <div class="pub-interacciones mt-2">
        <form asp-action="GestionLike" method="post" style="display: inline;">
            <input type="hidden" name="id" value="@Model.Id" />
            <button type="submit" class="like-button">❤️ @Model.CantLikes</button>
        </form>
        <button class="pub-btn-comentarios" data-id="@Model.Id">💬 Ver comentarios</button>
    </div>

    <!-- Comentarios -->
    <div class="pub-comentarios mt-2 d-none" id="comentarios-@Model.Id">
        @if (Model.Comentarios != null && Model.Comentarios.Any())
        {
            foreach (var com in Model.Comentarios)
            {
                <div class="pub-comentario mb-2">
                    <img src="@com.ImagenAutor.Url" class="pub-com-img" />
                    <div>
                        <p class="pub-com-autor">@com.AutorNombre</p>
                        <p class="pub-com-texto">@com.Contenido</p>

                        <!--Repsuesta de comentario -->
                        <a href="javascript:void(0);" onclick="mostrarFormRespuesta(@com.ComentarioId)">Responder</a>

                        <!-- Form para comentar oculto -->
                        <form asp-action="AgregarComentario" method="post" class="mt-2 d-none" id="form-respuesta-@com.ComentarioId">
                            <input type="hidden" name="publicacionId" value="@Model.Id" />
                            <input type="hidden" name="comentarioPadreId" value="@com.ComentarioId" />
                            <div class="input-group">
                                <input name="contenido" class="form-control form-control-sm" placeholder="Escribí una respuesta..." />
                                <button type="submit" class="btn btn-sm btn-primary">Enviar</button>
                            </div>
                        </form>

                        <!-- Respuestas -->
                        @if (com.Respuestas != null && com.Respuestas.Any())
                        {
                            @foreach (var resp in com.Respuestas)
                            {
                                <div class="pub-comentario">
                                    <img src="@resp.ImagenAutor.Url" class="pub-com-img" />
                                    <div>
                                        <p class="pub-com-autor">@resp.AutorNombre</p>
                                        <p class="pub-com-texto">@resp.Contenido</p>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted">No hay comentarios aún.</p>
        }
    </div>
    <div>
        <form asp-action="AgregarComentario" method="post" class="pub-comentar-form">
            <input type="hidden" name="publicacionId" value="@Model.Id" />
            <textarea name="contenido" placeholder="Escribí un comentario..."></textarea>
            <button type="submit" class="pub-btn-comentar">Comentar</button>
        </form>
    </div>

</div>
<script>
    function mostrarFormRespuesta(id) {
        document.getElementById(`form-respuesta-${id}`).classList.remove("d-none");
    }
</script>